trigger:
- master

pool:
  vmImage: 'macos-latest'

variables:
  buildConfiguration: 'Release'
  mdocPath: 'bin/$(buildConfiguration)'

stages:
  - stage: 'Build'
    jobs:
    - job: 'Build_UnitTest_CodeSigning_Archive'
      steps:
      - task: NuGetToolInstaller@1
        displayName: 'Install NuGet Tool'

      - task: Bash@3
        displayName: 'Run Unit Tests'
        inputs:
          targetType: 'inline'
          script: 'make prepare all check CONFIGURATION=Debug'

      - task: MSBuild@1
        displayName: 'Building mdoc In $(buildConfiguration) Mode'
        inputs:
          solution: 'apidoctools.sln'
          msbuildArguments: '/p:RunCodeAnalysis=False,RunCodeAnalysisOnThisProject=False'
          configuration: '$(buildConfiguration)'

      - task: EsrpCodeSigning@1
        displayName: Sign Executable And dll Files
        inputs:
          ConnectedServiceName: 'CodeSigning-APEX'
          FolderPath: '$(mdocPath)'
          UseMinimatch: true
          signConfigType: inlineSignParams
          SessionTimeout: '60'
          MaxConcurrency: '100'
          MaxRetryAttempts: '5'
          Pattern: |
              *.dll
              *.exe
          inlineOperation: |
            [
              {
                "KeyCode": "CP-236167",
                "OperationSetCode": "SigntoolSign",
                "parameters": [
                  {
                    "parameterName": "OpusName",
                    "parameterValue": "Microsoft"
                  },
                  {
                    "parameterName": "OpusInfo",
                    "parameterValue": "http://www.microsoft.com"
                  },
                  {
                    "parameterName": "PageHash",
                    "parameterValue": "/NPH"
                  },
                  {
                    "parameterName": "TimeStamp",
                    "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  },
                  {
                    "parameterName": "FileDigest",
                    "parameterValue": "/fd \"SHA256\""
                  }
                ],
                "ToolName": "sign",
                "ToolVersion": "1.0"
              },
              {
                "KeyCode": "CP-236167",
                "OperationSetCode": "SigntoolVerify",
                "Parameters": [
                  {
                    "parameterName": "VerifyAll",
                    "parameterValue": "/all"
                  }
                ],
                "ToolName": "sign",
                "ToolVersion": "1.0"
              }
            ]

      - task: ArchiveFiles@1
        displayName: Archive mdoc Files
        inputs:
              rootFolder: '$(mdocPath)'
              includeRootFolder: false
              archiveFile: '$(Build.ArtifactStagingDirectory)/zips/mdoc-$(Build.BuildId).zip'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish mdoc Atifact'
        inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/zips'
              artifact: 'mdoc.Artifact'